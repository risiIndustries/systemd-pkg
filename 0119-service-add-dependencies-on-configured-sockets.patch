From 423d96b0e5e351ae6489370ebc4af1bd18008b5d Mon Sep 17 00:00:00 2001
From: Lennart Poettering <lennart@poettering.net>
Date: Fri, 6 Jan 2012 19:23:03 +0100
Subject: [PATCH] service: add dependencies on configured sockets (cherry
 picked from commit
 73aa0c00df8b101bad4c3a038148a633df88610c)

---
 src/service.c |   22 ++++++++++++++++++++++
 1 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/src/service.c b/src/service.c
index d229301..65a45e1 100644
--- a/src/service.c
+++ b/src/service.c
@@ -1100,6 +1100,22 @@ static int service_add_default_dependencies(Service *s) {
         return unit_add_two_dependencies_by_name(UNIT(s), UNIT_BEFORE, UNIT_CONFLICTS, SPECIAL_SHUTDOWN_TARGET, NULL, true);
 }
 
+static int service_add_socket_dependencies(Service *s) {
+        Iterator i;
+        Unit *u;
+        int r;
+
+        /* Make sure we pull in all explicitly configured sockets */
+
+        SET_FOREACH(u, s->configured_sockets, i) {
+                r = unit_add_two_dependencies(UNIT(s), UNIT_AFTER, UNIT_REQUIRES, u, true);
+                if (r < 0)
+                        return r;
+        }
+
+        return 0;
+}
+
 static void service_fix_output(Service *s) {
         assert(s);
 
@@ -1173,6 +1189,12 @@ static int service_load(Unit *u) {
                         if ((r = unit_add_two_dependencies_by_name(u, UNIT_AFTER, UNIT_REQUIRES, SPECIAL_DBUS_SOCKET, NULL, true)) < 0)
                                 return r;
 
+                if (!set_isempty(s->configured_sockets)) {
+                        r = service_add_socket_dependencies(s);
+                        if (r < 0)
+                                return r;
+                }
+
                 if (s->meta.default_dependencies)
                         if ((r = service_add_default_dependencies(s)) < 0)
                                 return r;
